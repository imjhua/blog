---
layout: post
title: link 유형으로 리소스 우선순위 지정하기
categories: Web
---

브라우저는 중요한 리소스를 우선 로드하기 위한 방법을 가지고 있습니다. 예를 들면 스크립트나 이미지보다 CSS 또는 script를 먼저 로드 할 수 있습니다. 여기서는 link 속성(유형)에 따라 리소스의 우선순위를 변경 할 수 있는 방법에 대해 알아봅니다.

## 브라우저에서의 자원의 우선순위
기본적으로 브라우저(브라우저 구현에 따라 다름 크롭, 사파리 등등)는 여러유형의 리소스에 각각 상대적인 우선순위를 할당합니다. head 안에 정의된 CSS의 우선순위가 높고 다음 script순 입니다. Chrome 브라우저의 경우 Developer Tools의 Network 패널에서 우선순위를 확인 할 수 있습니다. 우선순위를 통해 각 리소스에 대한 브라우저 속성의 상대적인 중요성을 알 수 있습니다. 

## link 유형으로 리소스 우선순위 지정하기

브라우저가 제공하는 자원의 기본 우선순위를 변경하는 방법이 있습니다. 특정 속성들을 이용하여 우선순위를 변경 할 수 있습니다. 리소스가 사용자 환경에 필수적이지만 너무 낮은 우선순위로 로드된다면, 미리 로드를 하거나 미리연결을 통해 우선순위가 낮은 문제를 해결 할 수 있습니다. 반대로, 브라우저가 다른 모든 작업을 끝낸 후에만 일부 리소스를 가져오도록 하는 것도 가능합니다.

link는 외부의 resource와 현재 document의 연결을 정의하는 것으로, rel이라는 속성을 통해 어떠한 관계로 연결할 것인지 설정합니다.

### preload (미리로드)
브라우저에게 미리 로드해야 한다고, 현재 탐색에는 리소스가 필요하며 가능한 한 빠르게 가져오기를 시도해야 한다고 알려줍니다. link의 rel 속성값을 preload로 지정합니다. 브라우저는 미리 알기 때문에 다운로드를 더 일찍 시작 할 것입니다. preload는 브라우저가 반드시 리소스를 가져오게 만듭니다. 리소스를 중복 참조하면 중복된 개수만큼 리소스를 가져오기 때문에 리소스를 중복해서 참조하지 않도록 해야 합니다.

```html
<link rel="preload" as="script" href="super-important.js">
<link rel="preload" as="style" href="critical.css">
```

크롬에서는 현재 페이지에서 preload를 사용하여 로드 후 3초 내로 사용되지 않는 리소스는 Developer Tools의 Console에 경고를 트리거합니다. 그러니 주의해야 합니다.

참고) 경고의는 성능을 향상시키는 데 필요한 다른 리소스에 대해 캐시를 예열하기 위해 사전로드를 사용하고있을 수 있지만 이러한 사전로드 된 리소스를 사용하지 않는 경우 아무런 이유없이 추가 작업을 수행하기 때문입니다. 모바일에서 이것은 사용자의 데이터 계획을 낭비하는 것으로 요약되므로 미리로드하는 것을 염두해야 합니다.


#### as속성
<link> 요소에 rel="preload" 또는 rel="prefetch" 특성을 지정했을 때만 사용하는 속성입니다. as 특성은 <link> 요소가 불러오는 콘텐츠의 유형을 지정합니다. 요청 매칭, 올바른 콘텐츠 보안 정책의 적용, 올바른 Accept 요청 헤더 적용에 필요합니다. 이에 더해, rel="preload"는 as 특성을 사용해 요청 우선순위를 매깁니다. 다음 표는 특성의 유효한 값과, 해당 값이 적용되는 요소 또는 리소스를 나열합니다.

즉, preload를 사용하고자 할때에는, as 속성을 사용하여 리소스의 유형을 브라우저에 알려줘야 합니다. 올바른 유형이 설정되어 있지 않다면 브라우저는 해당 리소스를 사용하지 않습니다.

예를 들어, as="style"은 가장 높은 우선 순위를 가지며 as="script"는 낮거나 중간 우선 순위를 갖습니다. 이러한 리소스에도 동일한 CSP 정책 이 적용됩니다 (예: 스크립트에는 script-src가 적용됨). 

"as"가없는 사전로드 된 리소스는 비동기 XHR과 동일한 우선 순위 (따라서 높음)로 요청됩니다.


### preconnect (미리연결)
브라우저에게 페이지가 다른 곳에 연결되어야 한다는 것, 그리고 이것을 가능한 한 빠르게 처리를 시작하고자 한다는 것을 알려줍니다. 현재 페이지에서 외부 도메인의 리소스를 참고하는 것을 브라우저에게 알려 미리 외부 도메인과 연결을 설정할 수 있습니다.

preconnect를 사용하면 브라우저가 사이트에 필요한 연결을 미리 예상할 수 있게 됩니다. 브라우저는 필요한 소켓을 미리 설정할 수 있기 때문에 DNS, TCP, TLS 왕복에 필요한 시간을 절약할 수 있게 됩니다.

```html
<link rel="preconnect" href="http://example.com">
```

브라우저에게 example.com에 연결하고 여기에서 콘텐츠를 가져오려 한다는 것을 알립니다. 특히 연결이 10초 이내로 사용되지 않아 브라우저가 닫히면, 이전의 모든 연결 작업을 낭비하기 때문에 좋지 않습니다. 가져오는 것이 무엇인지 보다는 어디서 왔는지에 대해 아는 것에 집중합니다.

주의할 점으로는 preconnect는 외부 도메인과 연결을 구축하기 때문에 많은 CPU 시간을 차지할 수 있습니다. 보안 연결의 경우 더 많은 시간을 차지할 수 있습니다. 10초 이내로 브라우저가 닫힌다면, 이전의 모든 연결 작업은 낭비되는 것이기 때문에 브라우저가 빨리 닫힐 수 있는 페이지에서는 preconnect를 사용하지 않는 것이 좋습니다.

### prefetch (미리 가져오기)
preload(미리로드)와 햇갈릴 수 있습니다. prefetch 는 중요한 우선순위로 더 빠르게 로드 하는 것이 아니라, 기회가 있으면 중요하지 않는 것을 먼저 발생시키고자 하는 경우 적용하는 속성 값입니다. 미래에 사용될 것이라고 예상되는 리소스들을 prefetch해야 합니다. 브라우저는 미래에 사용될 리소스들을 가져와 캐시에 저장합니다.

필요할 수 있는 리소스를 브라우저에 알림으로써, 련재 페이지가 로딩을 마쳤고 사용 가능한 대역폭이 있을때 브라우저에서 가장 낮은 우선순위로 가져옵니다. 미리 가져온다는 것은, 사용자가 다음에 할 행동을 선점하여 준비하는데 가장 적합하다는 것을 의미합니다.

예를 들면, 결과목록에서 첫번재 제품 상세페이지를 가져오거나 페이지 번호가 있는 콘텐츠의 다음 페이지를 가져오는 것이 여기에 해당한다고 할 수 있습니다.

```html
<link rel="prefetch" href="page-2.html">
```

향후 여러 탐색에 걸쳐서 사용될 가능성이 높은 리소스들을 지정합니다. 중요 자원 및 탐색 요청을 병렬로 완료 할 수 있도록 리소스를 미리 준비할 수 있습니다. 주의할 점! 이것은 우선순위를 낮추는 것이 아닙니다.

주의사항으로는, 당장 사용하지 않더라고 캐시에 담아두기 때문에 정의된 모든 리소스를 다운로드하여 Request 요청 수가 많아지는 문제가 생길 수 있습니다.

## 크롬브랑저에서의 캐시 처리(preload & prefetch)
브라우저에서 preload와 prefetch는 캐시로 어떻게 동작할까요? 크롬의 경우 캐시는 다음과 같은 4가지의 유형의 캐시가 있습니다.

- HTTP 캐시
- 메모리 캐시
- Service Worker 캐시 
- 푸시 캐시

여기서, 프리로드 및 프리 페치 된 자원은 모두 HTTP 캐시에 저장 됩니다. 리소스가 미리로드되거나 프리 페치 되면 네트 스택에서 `HTTP 캐시` 및 `렌더러의 메모리 캐시`로 이동합니다. 리소스를 캐시 할 수있는 경우(예: 유효한 max-age를 가진 유효한 캐시 제어 가있는 경우) HTTP 캐시에 저장되며 현재 및 향후 세션에 사용할 수 있습니다 . 리소스를 캐시 할 수없는 경우 HTTP 캐시에 저장되지 않습니다. 대신 메모리 캐시로 올라가서 사용될 때까지 그대로 유지됩니다.

## 정리
link 유형으로 리소스 우선순위 지정하는 방법들이 있습니다. 브라우저에 리소스 및 연결을 사전에 선언적으로 알리고, 무엇인가가 발생했을 때 필요에 따라 변경할 수 있습니다.

- 현재 페이지에서 반드시 사용되는 리소스는 preload 합니다.
- 외부 도메인의 리소스는 preconnect 합니다.
- 미래에 사용되는 리소스는 prefetch 합니다.

- preload: 현재탐색! 브라우저가 as 속성과 해당 대상과 관련된 우선순위에 따라 현재 탐색에 사용할 대상 리소스(현재페이지에서 신뢰도가 높은 리소스)를 미리 가져와 캐시하도록 명시함.
- preconnect: 브라우저가 대상 리소스의 원본에 미리 연결하도록 명시함. 무엇보다는 어디서왔는지 명시.
- prefetch: 미래탐색! 사용자가 요청할 가능성이 있으므로, 브라우저가 대상 리소스를 미리 가져와 캐시(cache)하도록 명시함.

----
해당 내용은 다음 글을 참고 하였습니다.
- https://developers.google.com/web/fundamentals/performance/resource-prioritization?hl=ko
- https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf
- https://developer.mozilla.org/ko/docs/Web/HTML/Element/link
- https://developer.mozilla.org/ko/docs/Web/HTML/Preloading_content
- https://beomy.github.io/tech/browser/preload-preconnect-prefetch/