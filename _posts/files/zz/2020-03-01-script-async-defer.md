---
layout: post
title: 스크립트파일 로드 시점 제어 하기 (async, defer)
categories: JavaScript
---


일반적으로 브라우저가 위와 같은 문서를 만나게 되면 HTML을 파싱하고 외부 자원인 CSS, JS 파일을 로드하게 됩니다. 자바스크립트는 전달된 시점에 실행하게 되고 DOM 트리의 구축을 완료한 이후에 이미지 파일 및 플래시 등의 외부 리소스를 로드하면서 모든 작업이 완료됩니다. 스타일 시트는 이론적으로 DOM 트리를 변경하지 않기 때문에 문서 파싱을 기다리거나 중단하지 않습니다. 그러나 스크립트가 문서를 파싱하는 동안 스타일 정보를 요청하는 경우라면 문제가 됩니다. 스타일이 파싱되지 않은 상태라면 스크립트는 잘못된 결과를 내놓기 때문에 많은 문제를 야기합니다.


## 스크립트
중요한 점은 "스크립트를 만나게 되면 어떻게 되는 것인가" 입니다. JS인 script 태그를 만나면 스크립트가 해석 및 실행되는 동안 문서의 파싱은 중단되게 됩니다. 스크립트가 외부에 있는 경우 우선 네트워크로부터 자원을 가져와야 하는데 이 또한 실시간으로 처리되고 자원을 받을 때까지 파싱은 중단됩니다. 이 모델은 수 년간 지속됐고 HTML4와 HTML5의 명세에도 정의되어 있습니다.

참고) 파싱이란? 파싱은 DOM(Document Object Model) 트리를 만드는 과정으로 일반적으로 HTML, XML 파서를 각각 가지고 있음. HTML 파서는 말 그대로 HTML 문서를 해석하는데 사용되고, XML 파서는 XML 형식을 따르는 SVG, MathML 등을 처리하는데 사용함.

### 문제가 발생하는 경우
스크립트 파일을 먼저 로드하고 스타일을 불러오는 경우 즉, 스크립트가 문서를 파싱하는 동안 스타일 정보를 요청하는 경우라면 문제가 됩니다. 스크립트가 문서를 파싱하는 동안 브라우저는 다른 작업을 수행하지 않기 때문에 스타일이 파싱되지 않은 상태가 되고 이렇게 되었을 때 화면 레이아웃이 제대로 구성되지 않은 상태로 사용자에게 뷰를 제공하게 될 확률이 높기 때문에 사용자 경험(UX)을 떨어뜨리는 결과를 초래하게 될 것입니다. 이런 문제는 흔치 않은 것처럼 보이지만 매우 빈번하게 발생합니다. 이러한 문제를 야기시키지 않고 사용자 경험을 떨어뜨리지 않기 위해 다음과 같이 스크립트 소스를 body 태그 끝에 두는 것을 권장하고 있습니다. 스크립트 소스를 하단에 두게 되면 HTML 문서를 화면에 표시하는 속도가 빨라지게 되고 사용자가 뷰를 보는데 필요한 왠만한 문서를 해석한 상태이기 때문에 사용자의 불편을 초래하지 않을 수 있습니다.


### 스크립트의 로드 시점제어하기 - async, defer
문서의 head 영역에 스크립트가 삽입되거나 외부의 파일에 정의되어 있다면 이벤트 연결은 문서의 로드시점에 맞게 처리해야 할것입니다. head 에 삽입하는 경우에 모던 브라우저에서는 defer, async 속성을 사용할 수 있습니다.

참고)
- DOMContentLoaded: DOM 트리를 완성되는 시점. images 와 같은 외부 자원(iframe, image)을 제외(ex. embedded type)한 HTML Element 를 해석, 구성해 주는 것
- Load: 문서의 모든 콘텐츠(images, script, css, etc)가 로드된 상태





### 일반적인 실행
기본적으로 script 는 인라인 코드의 경우 즉시 해석되고 실행될 수 있지만 그렇지 않은 경우는 해당 파일을 가져올 때까지 HTML 문서의 구문 분석을 중단합니다. 스크립트를 가져 와서 실행하기 위해 HTML 구문 분석이 일시 중지되므로 HTML이 화면에 출력되는 시간이 길어지는 문제가 발생합니다.

```js
<script src="script.js">
```

### async 속성이 추가된 경우의 실행

async 속성은 브라우저에 스크립트 파일이 비동기적으로 실행될 수 있음을 나타내기 위해 사용됩니다. HTML 구문 분석기는 스크립트 태그에 도달한 지점에서 스크립트를 가져오고 실행하기 위해 일시 중지 할 필요가 없습니다. 따라서 HTML 구문 분석과 병행하여 스크립트를 가져온 후 스크립트가 준비 될 때마다 즉시 실행이 가능합니다. 그러므로 `실행의 순서가 다운로드 완료 시점의 결정되므로 실행 순서가 중요한 스크립트들에 async를 사용할 때는 유의해야 합니다`(HTML5 spec에 async=false 속성 지정시 호출 순서대로 실행되도록 추가됨(default : true)).


```js
<script async src="script.js">
```

### defer 속성이 추가된 경우의 실행

defer 속성은 HTML 구문 분석이 완전히 완료되면 스크립트 파일을 실행하도록 브라우저에 지시합니다.

```js
<script defer src="script.js">
```

비동기적으로 로드된 스크립트와 마찬가지로, HTML 구문 분석이 실행되는 동안 파일을 다운로드 할 수 있습니다. 그러나 `HTML 구문 분석이 완료되기 전에 스크립트 다운로드가 완료 되더라도 구문 분석이 완료 될 때까지 스크립트는 실행되지 않습니다`. 또한, async와는 다르게 호출된 순서대로 실행됩니다.
그렇기 때문에 먼저 선언된 스크립트 다운로드가 완료시점이 늦더라도 호출된 순서대로 실행되기 때문에 위에서 의존성을 잃어버릴 가능성이 있는 defer="true" 일 경우와는 다릅니다.

## 사용하는 경우
일반적인 스크립트 실행과 aync, defer 실행을 결정하기 위해서는 몇가지 확인해야 할 사항이 있습니다.

### <script> 요소는 어디에 있는가?

script 요소가 문서 맨 끝에 있지 않으면 스크립트의 비동기 및 지연 실행이 더 중요합니다. HTML 문서는 첫 번째 여는 <html> 요소부터 닫히는 순서로 파싱됩니다. 외부 소스 JavaScript 파일이 닫는 </body> 요소 바로 앞에 있으면, async 또는 defer 속성을 사용하는 것이 큰 효과가 없습니다(HTML 파서가 그 시점까지 문서의 대다수를 완성 했기 때문에 지연에 의미가 크게 없다는 것이다).

### 스크립트 자체가 포함되어 있는가?

다른 파일들에 종속적이지 않거나 종속성 자체가 없는 스크립트 파일의 경우 async 속성이 특히 유용합니다. 파일이 어느 지점에서 실행되는지 정확히 알 필요가 없기 때문에 비동기 로드가 가장 적합합니다.

### 스크립트가 완전히 구문 분석 된 DOM에 의존하는가?

대부분의 경우 스크립트 파일에는 DOM과의 상호 작용이 필요한 기능이 포함되어 있거나 페이지에 포함된 다른 파일에 대한 종속성이 있을 수 있습니다. 이러한 경우 스크립트를 실행하기 전에 DOM이 완전히 해석되어야 정상적인 동작을 할 수 있습니다. 일반적으로 이러한 스크립트 파일은 페이지의 맨 아래에 배치되어 모든 내용이 파싱된 후에 동작하도록 해야 합니다. 그러나 어떤 이유로든 문제의 파일을 다른 위치에 배치해야 하는 상황에서는 defer 속성을 사용할 수 있습니다.

### 스크립트가 작고 종속성을 가지는가?

마지막으로 스크립트가 비교적 작고 다른 파일에 의존하는 경우 인라인으로 정의하는 것이 더 유용 할 수 있습니다. 인라인을 사용하면 HTML 문서의 구문 분석이 차단되지만 크기가 작으면 큰 문제가 되지 않습니다. 또한 다른 파일에 의존하는 경우 차단이 필요할 수 있습니다.

## 결론

사이트의 성능을 향상시키는 방법을 이해하는데 다음 브라우저의 렌더링 순서는 매우 유용합니다.

- DOM 트리 구축(Constructing the DOM Tree)
- CSSOM 트리 구축(Constructing the CSSOM Tree)
- JavaScript 실행(Running JavaScript)
- 랜더링 트리 구축(Creating the Render Tree)
- 레이아웃 생성(Generating the Layout)
- 페인팅(Painting)

CSS는 "렌더링 차단 리소스"로, 완전히 파싱하지 않으면 렌더링 트리를 구성할 수 없습니다. JavaScript는 "파서 차단 리소스(parser blocking resource)"로, HTML 문서 자체의 구문 분석은 JavaScript에 의해 차단될 수 있습니다. 파서가 내부 태그이든 외부 태그이든 script 태그에 도달하면 (외부 태그 인 경우) fetch를 중단하고 실행합니다. 따라서 문서 내의 요소를 참조하는 JavaScript 파일이 있는 경우 해당 문서가 표시된 후에 배치 해야 합니다. JavaScript가 파서 차단(parser blocking)되는 것을 피하기 위해 async 속성을 적용하여 비동기적으로 로드 할 수 있습니다.

async와 defer를 지원하는 브라우저는 브라우저가 가지고 있는 JavaScript 엔진마다 약간 다를 수 있습니다.

---

해당 내용은 다음 글을 참고 하였습니다.

- https://blog.asamaru.net/2017/05/04/script-async-defer/
- https://d2.naver.com/helloworld/59361
- https://webclub.tistory.com/630
