---
layout: post
title: 메모리 저장 구조 이해하기 
categories: Programming
---

프로그램을 실행하게 되면 해당 프로그램은 메모리 영역에 올라가게 됩니다. 이렇게 메모리 영역에 올라가 있는 코드나 데이터를 CPU에서 필요한 명령어나 데이터를 읽어서 프로그램이 실행되게 되는데 크게 4가지로 구분됩니다.


## 영영
### 코드 영역 (Code Segment)
실제 프로그램 코드 자체가 적재되는 영역을 말합니다. C나 JAVA등의 개발 언어로 짜여진 프로그램은 컴퓨터가 이해할 수 있는 기계어의 형태로 컴파일 되어 파일 등에 저장되는데, 실제 이 파일의 프로그램에 대한 전체적인 코드 자체가 올라가는 영역입니다. 프로그램 자체 영역으로 보시면 됩니다.

- 프로그램 코드 자체가 기계어로 저장되는 영역
- 읽기 전용 데이터
- CPU 가 이 영역에 있는 명령을 읽고 처리

### 데이터 영역 (Data Segment)
프로그램이 실행되면서 필요한 변수가 저장되는 영역인데, 이 데이터 영역은 프로그램이 구동되는 동안 항상 접근 가능한 변수가 저장되는 영역이라고 생각하시면 됩니다. 즉, 전역 변수(Global Variables)와 정적 변수(Static Variables)를 위한 할당 공간입니다. 전역변수(global), 정적변수(static), 배열(array), 구조체(structure) 등이 저장됩니다. 초기화 되지 않은 데이터는 BSS 영역에 저장됩니다.

- 프로그램 시작과 동시에 할당되고 프로그램 종료 시 메모리에서 소멸. 
- 전역 변수, Static 변수 등과 같이 프로그램이 실행되는 동안 항상 접근 가능한 변수를 위한 공간
- DATA 에는 초기화 된 전역변수, BSS (Block Stated Symbol) 에는 초기화 값이 없는 전역변수 저장
- 함수 내부에 선언된 Static 변수는 프로그램이 실행될 때 공간만 할당되고, 함수가 실행될 때 초기화

### 힙 영역 (Heap Segment)
힙 영역은 위에서 관리가 가능한 데이터 외에 다른 형태의 데이터를 관리하기 위한 빈 공간(Free Space)입니다. 어떤 형태의 데이터가 있을까요? 바로 동적 할당(Dynamic Allocation)을 통해 생성된 동적 변수(Dynamic Variables)를 관리하기 위한 영역입니다. 힙 영역은 위의 다른 영역(데이터, 스택 등)을 모두 할당하고 남은 공간입니다. (남은 공간이라하여 딱히 영역에 제한이 있거나 그런 것은 아니고, 시스템의 메모리 공간 여유에 따라서 달라집니다.) Java 나 C++ 등에서 'new' 를 통해, C에서 'malloc', 'calloc' 등을 통해 동적으로 생성되는 변수를 저장하기 위해 할당되는 영역이라고 생각하시면 됩니다. 데이터 영역과 스택 영역은 컴파일러가 미리 공간을 예측하고 할당할 수 있지만, 동적 변수는 어느 시점에 어느 정도의 공간으로 할당 될지 정확하게 예측할 수 없기 때문에 프로그램 실행 중(Runtime)에 결정됩니다.

- 동적 할당 영역으로 참조타입 (Reference Type) 에 대한 저장 공간
- 스택은 엄격하게 LIFO 방식으로 동작하지만, 힙은 프로그램에 따라 일정한 순서나 규칙이 없음. 
- 더 이상 해당 힙 영역을 참조하는 변수가 없을 경우 소멸되며, 그 시점은 GC, ARC 등에 의해 결정 

### 스택 영역 (Stack Segment)
함수(또는 메서드, 프로시져 등) 내에 정의된 지역 변수(Local Variables)가 저장되는 영역입니다. 함수의 호출은 자료구조 중의 하나인 스택 구조 형태로 차곡차곡 메모리에 쌓이고, 처리가 끝나면 메모리에서 해제되는 모습을 보입니다. 가장 마지막에 들어간 것이 먼저 나오는 구조인 LIFO (Last In, First Out) 형태를 가진 스택 구조를 이용하면 이러한 데이터 관리를 쉽게 구현할 수 있을 것으로 보입니다. (함수 하나가 실행되면 해당 함수에서 사용되는 지역 변수의 메모리가 스택 영역에 쌓이고, 함수가 끝나면 해당 지역 변수는 더 이상 사용되지 않으므로 메모리에서 해제시킵니다.) 이렇게 스택의 구조를 활용하여 함수의 지역 변수 메모리를 관리하면 위의 메커니즘을 쉽게 구현할 수 있기 때문에 스택 형태로 영역을 만들어 활용하였고, 그리하여 스택 영역(스택 세그먼트)라고 합니다.

- 지역 변수, 매개변수, 리턴 값 등의 임시 데이터를 저장하는 영역
- 함수 시작과 함께 관련된 변수들이 생성되었다가 종료 시 반환되며, 
- 값 타입(Value Type) 저장 공간
- 후입선출 (LIFO, Last-In First-Out)
-  스택 프레임 (stack frame) : 스택 영역에 저장되는 함수와 관련된 호출 정보

스택 사이즈는 각 프로세스마다 할당 되지만 프로세스가 메모리에 로드 될 때 스택 사이즈가 고정되어 있어, 런타임 중에 스택 사이즈를 바꿀 수 없습니다.

 

 ## 메모리 저장
CODE, DATA, BSS 영역은 프로그램 컴파일 시 처음부터 크기가 정해지는 값들이 저장되는 곳으로 예를 들어, 소스코드 및 함수나 상수 등은 프로그램이 시작되어 끝날 때까지 크기 및 데이터가 변하지 않고 (읽기 전용),  전역 변수는 값은 변할지라도 그 데이터의 타입 크기는 변하지 않습니다. 따라서 메모리에서 차지하는 초기 할당량이 변하지 않고, 특별히 내부적으로 메모리주소값을 변형시키는 로직이 없다면 메모리 문제가 발생하지 않습니다. 그러나 스택과 힙 영역은 다릅니다. 스택에는 지역변수나 함수에 사용되는 인자 등이 할당 되는데 이것들은 코드 영역에 저장되어 있다가 런타임 시점에 지역변수가 필요할 때 스택영역에 해당 변수의 영역을 할당해주었다가 범위를 벗어나면 해제됩니다. (실제 변수가 할당될 위치와 순서, 변수의 데이터 타입에 따른 크기 등 스택이 차지할 크기 영역은 컴파일 시점에 결정된다.)

Heap 은 malloc에 의해 할당된 동적 포인터 변수나 인스턴스 들이 저장되는 영역인데, free 를 통해 명시적으로 해제하든 더 이상 사용되지 않아 Garbage Collector 등에 의해 수거되든 런타임 시점에 동적으로 할당되었다가 해제되게 됩니다. 따라서 이 둘은 할당받은 일정 메모리 공간 내에서, `빈 공간을 사이에 두고 힙은 낮은 곳에서 높은 메모리 주소로, 스택은 높은 메모리 주소에서 낮은 곳으로 크기를 키우며 메모리 공간을 차지`합니다. 그러다 스택과 힙에 할당된 영역보다 더 큰 메모리가 필요해지는 순간, 오버플로우가 발생하게 됩니다. 힙이 커져서 생긴 문제면 힙 오버플로우, 스택이 커져서 생긴 문제면 스택 오버플로우가 발생합니다.

## 프로세스와 스레트의 메모리 구조
지금까지 언급한 메모리 저장 구조는 프로세스와 쓰레드의 컨텍스트 스위칭과 연결지어 생각해볼 수 있습니다. 프로세스는 각 프로세스 별로 독립적인 [ Code, Data, Heap, Stack ]  영역을 소유하게 됩니다. 따라서 프로세스 전환 시, 메모리의 전 영역에 대해 컨텍스트 스위칭 비용이 발생합니다. 이에 비해 쓰레드는 [ Code, Data, Heap ] 영역은  서로 공유하고, Stack 영역만 별도로 소유합니다. 이런 차이로 스위칭 비용이 프로세스에 비해 훨씬 적게 드는 것입니다.

## 메모리 생명주기

어떤 언어를 사용하든간에 메모리 생명주기는 거의 비슷합니다.
아래는 메모리 생명주기의 각 단계에 대한 대략적인 설명입니다.

- 메모리 할당(allocate): 프로그램이 사용할 수 있도록 운영체제가 메모리를 할당합니다. 저수준 언어(예를 들어 C)에서는 이를 개발자가 명시적으로 처리해줘야 합니다. 그러나 고수준 언어에서는 개발자가 신경쓸 필요 없습니다.
- 메모리 사용(use): 이제 할당된 메모리를 실제로 프로그램이 사용하는 단계입니다. 개발자가 코드 상에서 할당된 변수를 사용함으로써 읽기와 쓰기 작업이 이루어집니다.
- 메모리 해제(release): 프로그램에서 필요하지 않은 메모리 전체를 되돌려주어 다시 사용가능하게 만드는 단계입니다. 메모리 할당 작업과 마찬가지로 저수준 언어에서는 이를 명시적으로 처리해야 합니다.

## 정리
- 코드영역은 우리가 적은 코드가 적재되는 영역이다. 컴파일이 끝난 기계어로 들어간다고 한다.
- 데이터 영역은 전역 변수 static 변수들이 적재되는 곳이다. 프로그램이 끝날때까지 존재한다.
- 스택 영역은 지역변수, 매개 변수들이 저장이 되는데 함수 호출시 사용되고 끝나면 반환된다.
- 함수가 호출될때 그 메모리가 할당된다고 하여 콜 스택이라고 불리운다. 선입후출의 자료구조이다. 컴파일 시에 크기가 결정된다
- 힙 영역은 메모리가 동적으로 할당되는 곳이다. 런타임시에 크기가 결정된다.

데이터 영역과 스택 영역은 컴파일러가 미리 공간을 예측하고 할당할 수 있지만, 동적 변수(힙 영역)는 어느 시점에 어느 정도의 공간으로 할당 될지 정확하게 예측할 수 없기 때문에 프로그램 실행 중에 결정됩니다.


----
해당 내용은 다음 글을 참고 하였습니다.
- https://ooz.co.kr/244
- https://m.blog.naver.com/PostView.nhn?blogId=itperson&logNo=220821884483&proxyReferer=https%3A%2F%2Fwww.google.com%2F
- https://engineering.huiseoul.com/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9E%91%EB%8F%99%ED%95%98%EB%8A%94%EA%B0%80-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EA%B4%80%EB%A6%AC-4%EA%B0%80%EC%A7%80-%ED%9D%94%ED%95%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EB%88%84%EC%88%98-%EB%8C%80%EC%B2%98%EB%B2%95-5b0d217d788d